<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proceso del Pedido</title>
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&family=Montserrat&display=swap" rel="stylesheet">
    <style>
        :root {
            --rojo-intenso: #d91e18;
            --blanco-puro: #ffffff;
            --negro-elegante: #222222;
            --azul-pastel: #7ec8e3;
            --azul-fuerte: #176ea6;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(to bottom right, #fb7070, #70b4fb);
            margin: 0;
            padding: 0;
            color: var(--negro-elegante);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            position: relative;
            max-width: 900px;
            width: 90%;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .form-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .form-container input[type="text"] {
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-rastrear {
            background: linear-gradient(45deg, var(--rojo-intenso), var(--azul-pastel));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 5px 15px rgba(217, 30, 24, 0.3);
        }
        .btn-rastrear:hover {
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(217, 30, 24, 0.6);
        }

        h2 {
            font-family: 'Sawarabi Mincho', serif;
            font-size: 2.5rem;
            color: var(--rojo-intenso);
            margin-bottom: 20px;
        }

        p {
            font-size: 1.1rem;
            margin: 5px 0;
        }

        .timeline {
            position: relative;
            height: 150px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 50px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 5%;
            width: 90%;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            transform: translateY(-50%);
        }

        .progress {
            position: absolute;
            top: 50%;
            left: 5%;
            height: 10px;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            border-radius: 5px;
            width: 0;
            transition: width 0.3s linear;
            transform: translateY(-50%);
            z-index: 1;
        }

        .stage {
            text-align: center;
            z-index: 2;
            width: 80px;
            flex-shrink: 0;
            position: relative;
        }

        .stage .circle {
            width: 50px;
            height: 50px;
            background: var(--blanco-puro);
            border-radius: 50%;
            margin: 0 auto 10px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease;
        }

        .stage.completed .circle {
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            box-shadow: 0 0 15px #ff00ff;
        }

        .mascot {
            position: absolute;
            top: 50%;
            width: 60px;
            height: 60px;
            transform: translate(-50%, -50%);
            transition: left 1s linear;
            z-index: 3;
        }

        .stage p {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .btn-volver {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(45deg, var(--rojo-intenso), var(--azul-pastel));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(217, 30, 24, 0.3);
            transition: transform 0.2s ease;
        }
        .btn-volver:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>

<button class="btn-volver" onclick="window.location.href='index.html'">‚¨Ö Volver al inicio</button>

<div class="container">
    <form id="tracking-form" class="form-container">
        <input type="text" id="codigo-input" placeholder="Ingresa tu c√≥digo de pedido" required>
        <button type="submit" class="btn-rastrear">Rastrear</button>
    </form>

    <div id="tracking-info" style="display:none;">
        <h2>Seguimiento de tu pedido ‚ú®</h2>
        <p>C√≥digo: <strong id="codigo"></strong></p>
        <p id="mensajeEnvio"></p>
        <div class="timeline">
            <div class="progress" id="progress"></div>
            <img src="sakurai.png" class="mascot" id="mascot">
            <div class="stage" id="stage-0"><div class="circle">‚úî</div><p>Verificaci√≥n</p></div>
            <div class="stage" id="stage-1"><div class="circle">üë©‚Äçüç≥</div><p>Producci√≥n</p></div>
            <div class="stage" id="stage-2"><div class="circle">üéÅ</div><p>Empaquetado</p></div>
            <div class="stage" id="stage-3"><div class="circle">üõµ</div><p>Env√≠o</p></div>
            <div class="stage" id="stage-4"><div class="circle">üè°</div><p>Entregado</p></div>
        </div>
        <p id="tiempo-restante" style="margin-top: 40px; font-weight: bold;"></p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const codigoGuardado = localStorage.getItem("codigoPedido");
        const tipoEnvioGuardado = localStorage.getItem("tipoEnvio");
        const startTimeGuardado = localStorage.getItem("startTime");

        if (codigoGuardado && tipoEnvioGuardado && startTimeGuardado) {
            document.getElementById('tracking-form').style.display = 'none';
            document.getElementById('tracking-info').style.display = 'block';
            
            // Calculamos el tiempo transcurrido desde que se pidi√≥ el c√≥digo
            const tiempoTranscurrido = Date.now() - parseInt(startTimeGuardado);
            iniciarSeguimiento(codigoGuardado, tipoEnvioGuardado, tiempoTranscurrido);
        }
    });

    document.getElementById('tracking-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const codigo = document.getElementById('codigo-input').value;

        // Limpiamos el localStorage cuando se inicia un nuevo seguimiento
        localStorage.removeItem("codigoPedido");
        localStorage.removeItem("tipoEnvio");
        localStorage.removeItem("startTime");

        const tipoEnvio = codigo.toUpperCase().includes('CHIA') || codigo.toUpperCase().includes('CAJICA') ? 'lejos' : 'cerca';
        
        document.getElementById('tracking-form').style.display = 'none';
        document.getElementById('tracking-info').style.display = 'block';

        // Si se ingresa el c√≥digo manualmente, se considera un nuevo inicio
        iniciarSeguimiento(codigo, tipoEnvio, 0);
    });

    function iniciarSeguimiento(codigo, tipoEnvio, tiempoInicial = 0) {
        const mascot = document.getElementById("mascot");
        const progress = document.getElementById("progress");
        const stages = document.querySelectorAll('.stage');
        
        document.getElementById("codigo").textContent = codigo;
        document.getElementById("mensajeEnvio").textContent = tipoEnvio === "cerca" ?
            "Env√≠o cercano (5-10 minutos en la etapa final)" :
            "Env√≠o lejano (20-40 minutos en la etapa final)";

        const duracionEnvioMinutos = tipoEnvio === "cerca" ? (5 + 10) / 2 : (20 + 40) / 2;

        const etapas = [
            { id: 'stage-0', duracion: 5 * 60, titulo: "Verificaci√≥n" },
            { id: 'stage-1', duracion: (20 + 30) / 2 * 60, titulo: "Producci√≥n" },
            { id: 'stage-2', duracion: (2 + 5) / 2 * 60, titulo: "Empaquetado" },
            { id: 'stage-3', duracion: duracionEnvioMinutos * 60, titulo: "Env√≠o" },
            { id: 'stage-4', duracion: 0, titulo: "Entregado" }
        ];

        const totalTiempo = etapas.reduce((acc, e) => acc + e.duracion, 0);
        let anchoLinea = 90; // porcentaje
        
        let tiempoTranscurridoTotal = tiempoInicial / 1000; // Convertir de ms a segundos
        let progresoAcumulado = 0;
        let etapaActualIndex = 0;

        // Calcular la etapa actual y el progreso inicial basado en el tiempo transcurrido
        let tiempoTotalPasadoEtapas = 0;
        let porcentajeAcumuladoEtapas = 0;
        const distanciaEntreEtapas = anchoLinea / (etapas.length - 1);
        
        for (let i = 0; i < etapas.length; i++) {
            const etapa = etapas[i];
            const duracionEtapa = etapa.duracion;
            
            if (tiempoTranscurridoTotal >= tiempoTotalPasadoEtapas + duracionEtapa && duracionEtapa > 0) {
                tiempoTotalPasadoEtapas += duracionEtapa;
                stages[i].classList.add('completed');
                etapaActualIndex = i + 1;
                porcentajeAcumuladoEtapas += distanciaEntreEtapas;
            } else {
                break;
            }
        }
        
        // Calcular el progreso dentro de la etapa actual
        if (etapaActualIndex < etapas.length) {
            const etapaActual = etapas[etapaActualIndex];
            const tiempoEnEtapa = tiempoTranscurridoTotal - tiempoTotalPasadoEtapas;
            const progresoEnEtapa = (etapaActual.duracion > 0) ? (tiempoEnEtapa / etapaActual.duracion) : 1;
            progresoAcumulado = porcentajeAcumuladoEtapas + (distanciaEntreEtapas * progresoEnEtapa);
        } else {
            // El pedido ya ha sido entregado
            progresoAcumulado = 100;
            stages[etapas.length - 1].classList.add('completed');
        }

        // Colocamos la mascota y la barra de progreso en su posici√≥n inicial calculada
        progress.style.width = progresoAcumulado + "%";
        mascot.style.left = `calc(${5 + progresoAcumulado}% - 30px)`;

        function actualizarTiempoRestante() {
            const tiempoRestanteTotal = totalTiempo - tiempoTranscurridoTotal;
            const minutosRestantes = Math.floor(tiempoRestanteTotal / 60);
            const segundosRestantes = Math.floor(tiempoRestanteTotal % 60);
            
            const etapaActual = etapas[etapaActualIndex] ? etapas[etapaActualIndex].titulo : "Entregado";

            if (tiempoRestanteTotal > 0) {
                document.getElementById('tiempo-restante').textContent =
                    `Etapa actual: ${etapaActual} | Tiempo restante: ${minutosRestantes}m ${segundosRestantes}s`;
            } else {
                document.getElementById('tiempo-restante').textContent = "¬°Tu pedido ha sido entregado!";
                // Opcional: limpiar localStorage para que la pr√≥xima vez que el usuario entre, vea el formulario
                localStorage.removeItem("codigoPedido");
                localStorage.removeItem("tipoEnvio");
                localStorage.removeItem("startTime");
            }
        }

        let interval = setInterval(() => {
            if (tiempoTranscurridoTotal >= totalTiempo) {
                clearInterval(interval);
                // Aseguramos que la √∫ltima etapa se marque como completada
                stages[etapas.length - 1].classList.add('completed');
                progress.style.width = "100%";
                mascot.style.left = `calc(${5 + 100}% - 30px)`;
                actualizarTiempoRestante();
                return;
            }

            tiempoTranscurridoTotal++;

            // Mueve el progreso y la mascota
            const tiempoEnEtapa = tiempoTranscurridoTotal - tiempoTotalPasadoEtapas;
            const etapaActual = etapas[etapaActualIndex];
            if (tiempoEnEtapa >= etapaActual.duracion && etapaActual.duracion > 0) {
                stages[etapaActualIndex].classList.add('completed');
                tiempoTotalPasadoEtapas += etapaActual.duracion;
                etapaActualIndex++;
                if(etapaActualIndex < etapas.length){
                    // Resetear el progreso dentro de la nueva etapa
                    progresoAcumulado = porcentajeAcumuladoEtapas + (distanciaEntreEtapas * etapaActualIndex);
                }
            }
            
            if(etapaActualIndex < etapas.length){
                const progresoEnEtapa = (etapas[etapaActualIndex].duracion > 0) ? (tiempoTranscurridoTotal - tiempoTotalPasadoEtapas) / etapas[etapaActualIndex].duracion : 1;
                progresoAcumulado = porcentajeAcumuladoEtapas + (distanciaEntreEtapas * (etapaActualIndex + progresoEnEtapa));
            } else {
                 progresoAcumulado = 100;
            }
            
            progress.style.width = progresoAcumulado + "%";
            mascot.style.left = `calc(${5 + progresoAcumulado}% - 30px)`;
            
            actualizarTiempoRestante();

        }, 1000);

        // Llamada inicial para establecer el estado
        actualizarTiempoRestante();
    }
</script>
</body>
</html>
